name: Build OpenLieroX

on:
  push:
    branches: ["main"]
    tags: ["*"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - {
              name: "linux-x64",
              triple: "x86_64-linux-gnu",
              cmake_flags: "-DX11=ON",
            }
          - { name: "macos-x64", triple: "x86_64-macos-none", cmake_flags: "" }
          - {
              name: "windows-x64",
              triple: "x86_64-windows-gnu",
              cmake_flags: "",
              exe_suffix: ".exe",
            }

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for git describe to work

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            libsdl2-dev \
            libsdl2-mixer-dev \
            libsdl2-image-dev \
            libgd-dev \
            zlib1g-dev \
            libzip-dev \
            libxml2-dev \
            libx11-dev \
            libcurl4-gnutls-dev \
            libboost-all-dev \
            libopenal-dev \
            libalut-dev \
            libvorbis-dev \
            binutils-dev

      - name: Configure CMake with Zig
        run: |
          cmake -B build-${{ matrix.target.name }} \
            -DCMAKE_C_COMPILER="zig;cc;-target;${{ matrix.target.triple }}" \
            -DCMAKE_CXX_COMPILER="zig;c++;-target;${{ matrix.target.triple }}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DHAWKNL_BUILTIN=Yes \
            -DDEBUG=OFF \
            ${{ matrix.target.cmake_flags }}

      - name: Build
        run: cmake --build build-${{ matrix.target.name }} -j$(nproc)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openlierox-${{ matrix.target.name }}
          path: build-${{ matrix.target.name }}/bin/openlierox${{ matrix.target.exe_suffix }}
